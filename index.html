<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Beks Game - Kirish</title>
  <link rel="stylesheet" href="index.css">
</head>
<body>

  <h1>Beks Game</h1>

  <!-- LOGIN FORM (default ochiq) -->
  <div id="loginForm" style="display:block; max-width:400px; margin:auto;">
    <h2>Kirish</h2>
    <input type="email" id="loginEmail" placeholder="Email" required><br><br>
    <input type="password" id="loginPassword" placeholder="Parol" required><br><br>
    <button onclick="loginUser()">Kirish</button>
    <button onclick="loginOffline()" style="margin-top:10px;">
  ğŸŒ Offline (Mehmon)
</button>
    <p>Yoki <span id="showRegister" style="color:blue;cursor:pointer;">Roâ€˜yxatdan oâ€˜tish</span></p>
  </div>

  <!-- REGISTER FORM (default yopiq) -->
  <div id="registerForm" style="display:none; max-width:400px; margin:auto;">
    <h2>Roâ€˜yxatdan oâ€˜tish</h2>
    <input type="text" id="registerName" placeholder="Ism" required><br><br>
    <input type="email" id="registerEmail" placeholder="Email" required><br><br>
    <input type="password" id="registerPassword" placeholder="Parol" required><br><br>
    <input type="password" id="registerPasswordConfirm" placeholder="Parolni tasdiqlash" required><br><br>
    <button onclick="registerUser()">Roâ€˜yxatdan oâ€˜tish</button>
    <p>Yoki <span id="showLogin" style="color:blue;cursor:pointer;">Kirish</span></p>
  </div>

  <script type="module">
  import { auth } from "./firebase.js";
  import { 
    createUserWithEmailAndPassword, 
    signInWithEmailAndPassword, 
    updateProfile,
    setPersistence,
    browserLocalPersistence,
    onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

  // =========================
  // ğŸ”¥ 1) OFFLINE UCHUN PERSISTENCE
  // =========================
  try {
    await setPersistence(auth, browserLocalPersistence);
    console.log("âœ… Auth persistence yoqildi (offline qoâ€˜llab-quvvatlash)");
  } catch (e) {
    console.warn("âš ï¸ Persistence yoqilmadi:", e);
  }

  // =========================
  // ğŸ”„ FORM TOGGLE
  // =========================
  document.getElementById("showRegister").onclick = () => {
    document.getElementById("loginForm").style.display = "none";
    document.getElementById("registerForm").style.display = "block";
  };

  document.getElementById("showLogin").onclick = () => {
    document.getElementById("registerForm").style.display = "none";
    document.getElementById("loginForm").style.display = "block";
  };

  // =========================
  // âœ… LOGIN
  // =========================
  window.loginUser = async () => {
    const email = document.getElementById("loginEmail").value.trim();
    const password = document.getElementById("loginPassword").value;

    if (!email || !password) {
      return alert("Email va parol kiriting!");
    }

    try {
      await signInWithEmailAndPassword(auth, email, password);

      // UID ni localStorage ga saqlaymiz (game.js ga kerak)
      localStorage.setItem("uid", auth.currentUser.uid);

      window.location.href = "game.html";
    } catch (e) {
      console.error(e);

      if (e.code === "auth/network-request-failed") {
        alert("âŒ Internet yoâ€˜q!\nAgar oldin shu qurilmada kirgan boâ€˜lsangiz, qayta urinib koâ€˜ring.");
      } else {
        alert("Xato: " + e.message);
      }
    }
  };

  // =========================
  // âœ… REGISTER
  // =========================
  window.registerUser = async () => {
    const name = document.getElementById("registerName").value.trim();
    const email = document.getElementById("registerEmail").value.trim();
    const password = document.getElementById("registerPassword").value;
    const passwordConfirm = document.getElementById("registerPasswordConfirm").value;

    if (!name || !email || !password || !passwordConfirm) {
      return alert("Barcha maydonlar toâ€˜ldirilishi kerak!");
    }

    if (password !== passwordConfirm) {
      return alert("Parol va tasdiqlash mos emas!");
    }

    try {
      const userCred = await createUserWithEmailAndPassword(auth, email, password);

      // Ismni profilga yozamiz
      await updateProfile(userCred.user, { displayName: name });

      // UID ni localStorage ga saqlaymiz
      localStorage.setItem("uid", userCred.user.uid);

      window.location.href = "game.html";
    } catch (e) {
      console.error(e);
      alert("Xato: " + e.message);
    }
  };

  // =========================
  // ğŸ”¹ OFFLINE (GUEST) MODE
  // =========================
  window.loginOffline = () => {
    localStorage.setItem("uid", "guest_offline");
    window.location.href = "game.html";
  };

  // =========================
  // ğŸ” AGAR ALLAQACHON KIRGAN BOâ€˜LSA â€” AVTOMAT KIRISH
  // =========================
  onAuthStateChanged(auth, (user) => {
    if (user) {
      console.log("Oldindan kirilgan user:", user.uid);
      localStorage.setItem("uid", user.uid);
      // ixtiyoriy: avtomatik oâ€˜tkazish
      // window.location.href = "game.html";
    }
  });
</script>

</body>
</html>
